<?xml version="1.0" encoding="utf-8" ?>
<odoo>
<record id="view_stock_move_line_operation_tree_at" model="ir.ui.view">
        <field name="name">Stock Move Line Alternative Tracking</field>
        <field name="model">stock.move.line</field>
        <field name="inherit_id" ref="stock.view_stock_move_line_operation_tree" />
        <field name="arch" type="xml">
            <field name="product_uom_id" position="after">
                <field name="template_tracking" invisible="1" />
                <button
                    name="action_open_tracking_form"
                    string="Open tracking"
                    type="object"
                    icon="fa-barcode"
                    context="{'recal_qty_done': True}"
                    attrs="{'invisible': [('template_tracking', '!=', 'virtual')]}"
                />
            </field>
        </field>
</record>

<record id="view_move_form_At" model="ir.ui.view">
        <field name="name">Stock Move Alternative Tracking</field>
        <field name="model">stock.move</field>
        <field name="inherit_id" ref="stock.view_move_form"/>
        <field name="arch" type="xml">
                <xpath expr="//div[@name='button_box']" position="inside">
                <button
                    name="action_view_serials"
                    string="Series/Lotes"
                    type="object"
                    icon="fa-barcode"
                />
            </xpath>
        </field>
    </record>




<record id="stock_move_line_tracking_form_tree_serial" model="ir.ui.view">
        <field name="name">Stock Move Line Tracking Form Tracking Tree Serial</field>
        <field name="model">stock.move.line</field>
        <field name="priority">9999</field>
        <field name="arch" type="xml">
            <form string="Move Detail">
                <header>
                    <field name="state" widget="statusbar" readonly="1"/>
                </header>
                <group> 
                    <group>
                        <field name="product_id" readonly="1"/>
                        <!--field name="template_tracking" invisible="1" readonly="1"/-->
                    </group>
                    <group>
                        <field name="location_id" invisible="0" readonly="1"/>
                        <field name="location_dest_id" invisible="0" readonly="1"/>
                        <field name="serial_location" invisible="1"/>
                    </group>
                </group>
                <group string="Nº de Serie">
                    <label string="Show lot names" for="show_name_ids"/>
                    <div class="o_row">
                        <span>
                            <field name="show_name_ids" attrs="{'readonly': [('state', '=', 'done')]}"/>
                        </span>
                    </div>
                    <group  attrs="{'invisible': [('show_name_ids', '=', True)]}">
                        <field name="serial_name_ids" 
                            nolabel="1"
                            domain = "[('move_line_id', '=', id)]"
                            context="{'default_move_line_id': id, 'default_product_id': product_id}" 
                            attrs="{'readonly': [('state', '=', 'done')]}">
                            <tree editable="bottom" create="1">
                                <field name="move_line_id" readonly="1" invisible="1"/>
                                <field name="name"/>
                            </tree>
                        </field>
                    </group>
                    <group attrs="{'invisible': [('show_name_ids', '=', False)]}">
                        <field name="serial_ids" 
                            nolabel="1"
                            options="{'no_open': True, 'no_create': True, 'no_create_edit': True}"
                            domain = "[('product_id', '=', product_id), ('real_location_id', 'child_of', serial_location)]"
                            context="{'default_location_id': serial_location, 'default_real_location_id': location_id, 'default_product_id': product_id}" 
                            attrs="{'readonly': [('state', '=', 'done')]}"
                            widget="many2many_tags">
                        </field>
                    </group>
                </group>
            </form>
        </field>
</record>

<record id="stock_move_line_tracking_form" model="ir.ui.view">
        <field name="name">Stock Move Line Tracking Form Tracking</field>
        <field name="model">stock.move.line</field>
        <field name="priority">9999</field>
        <field name="arch" type="xml">
              
             <form string="Move Detail">
                 <header>
                     <field name="state" widget="statusbar" readonly="1"/>
                 </header>
                 <group attrs="{'invisible': [('state', '=', 'done')]}">
                    <group>
                         
                        <field name="location_id" invisible="0" readonly="1"/>
                        <field name="location_dest_id" invisible="0"/>
                    </group>
                    <group>
                       <field name="picking_id" invisible="1" readonly="1"/>
                        <field name="is_locked" invisible="1" readonly="1"/>
                    </group>
                </group>
                    <group attrs="{'invisible': [('state', '=', 'done')]}">
                        <group string="Principal">
                            <field name="product_id" readonly="1"/>
                            <field string="Tracking" name="template_tracking"/>
                            <field string="Tracking" name="tracking" invisible="1"/>
                            
                        </group>
                        <group string="Tracking">
                            <label for="product_qty"/>
                            <div class="o_row">
                                <span><field name="product_qty" readonly="1" nolabel="1"/></span>
                                <span><field name="product_uom_id" readonly="1" nolabel="1"/></span>
                            </div>
                            <label for="qty_done"/>
                            <div class="o_row">
                                <span><field name="qty_done" attrs="{'readonly': [('state', '=', 'done')]}" nolabel="1"/></span>
                                <span><field name="product_uom_id" readonly="1" nolabel="1"/></span>
                            </div>
                            <field name="lot_name"  attrs="{'invisible': ['|', ('template_tracking', '=', 'virtual'), ('tracking','!=', 'none')]}"/>
                            <field name="lot_id"  attrs="{'invisible': ['|', ('template_tracking', '=', 'virtual'), ('tracking','!=', 'none')]}"/>
                        </group>
                     </group>
                    
                     <div attrs="{'invisible': [('template_tracking','!=', 'virtual')]}" >
                        <group string="Tracking" groups="base.group_no_one" >
                            <group invisible="0">
                                <field name="picking_type_use_existing_lots"/>
                                <field name="picking_type_use_create_lots"/>
                            </group>
                            <group invisible="0">
                                <field name="template_tracking"/>
                                <field options="{'no_create': True}" name="available_serial_ids"
                                    context="{'default_product_id': product_id, 'default_virtual_tracking': 1}" 
                                    widget="many2many_tags"/>
                            
                            </group>
                        </group>
                        <group  attrs="{'invisible': ['|', ('state', '==', 'done'), ('picking_type_use_create_lots', '=', False)]}">
                            <label for="lot_ids_string" string="Cadena de texto"/>
                            <field name="lot_ids_string" nolabel="1" 
                                attrs="{'readonly': [('state', '=', 'done')]}"/>
                            <label for="serial_name_ids" string="Nº Nuevos"/>
                            <field name="serial_name_ids" nolabel="1" widget="many2many_tags" 
                                options="{'no_create': True}" 
                                domain = "[('move_line_id', '=', id)]"
                                context="{'default_product_id': product_id, 'default_virtual_tracking': 1}" 
                                attrs="{'readonly': [('state', '=', 'done')]}" />
                        </group>
                        <group attrs="{'invisible': [('state', '!=', 'done'),  ('picking_type_use_existing_lots', '=', False)]}">
                            <label for="serial_ids" string="Nº existentes"/>
                            <field name="serial_ids" nolabel="1" 
                                widget="many2many_tags" options="{'no_create': True}" 
                                attrs="{'readonly': [('state', '=', 'done')]}"
                                domain="[('id', 'in', available_serial_ids)]"/>
                        </group>
                    </div>
                    
                    <footer class="oe_edit_only">
                        <button string="Convertir a Nº de serie" 
                            type="object" name="apply_lot_ids_string" class="oe_highlight" 
                            context="{'recal_qty_done': True}"
                            attrs="{'invisible': [ '|', '|', ('state', '=', 'done'), ('lot_ids_string', '=', ''), ('template_tracking', '!=', 'virtual')]}"/>
                        <button string="Confirm" attrs="{'invisible': [('lot_ids_string', '!=', '')]}" special="save" class="oe_highlight"/>
                        <button string="Discard" special="cancel"/>
                    </footer>
            </form>
        
        </field>
</record>
<record id="view_stock_move_operations_at" model="ir.ui.view">
    <field name="name">stock.move.operations.form.at</field>
    <field name="model">stock.move</field>
    <field name="inherit_id" ref="stock.view_stock_move_operations" />
    <field name="arch" type="xml">
        <field name="move_line_ids" position="before">
            <group
                    string="Tracking"
                    attrs="{'invisible': [('template_tracking', '!=', 'virtual')]}"
                >
                <group groups="base.group_no_one">
                    <group>
                        <field name="use_existing_lots" />
                        <field name="use_create_lots" />
                    </group>
                    <group>
                        <field name="template_tracking" />
                        <field
                                name="available_serial_ids"
                                context="{'default_product_id': product_id, 'default_virtual_tracking': 1}"
                                nolabel="1"
                                widget="many2many_tags"
                            />
                    </group>

                </group>
            </group>
            <field
                    name="lot_ids_string"
                    nolabel="1"
                    attrs="{'readonly': [('state', '=', 'done')],
                            'invisible': ['|', ('state', '=', 'done'), ('template_tracking', '!=', 'virtual')]}"
                            />
        </field>
        <field name="move_line_ids" position="after">
            <field
                name="serial_ids"
                options="{'no_create': True}"
                nolabel="1"
                widget="many2many_tags"
                context="{'default_product_id': product_id, 'default_virtual_tracking': 1}"
                attrs="{'readonly': [('state', '=', 'done')],
                        'invisible': ['|', ('template_tracking', '!=', 'virtual'), ('use_create_lots', '=', True)]}"
                domain="[('id', 'in', available_serial_ids)]"
            />
            <field
                name="serial_name_ids"
                options="{'no_create': True}"
                nolabel="1"
                widget="many2many_tags"
                context="{'default_product_id': product_id, 'default_virtual_tracking': 1}"
                attrs="{'readonly': [('state', '=', 'done')],
                        'invisible': ['|', ('template_tracking', '!=', 'virtual'), ('use_create_lots', '=', False)]}"
                domain="[('id', 'in', available_serial_ids)]"
            />
       </field>
        <xpath expr="//button[@special='save']" position="replace">
            <button string="Confirm" special="save" class="oe_highlight" context="{'recal_qty_done':True}"/>
        </xpath>
        <xpath expr="//footer" position="inside">
            <button
                    string="Apply Lots"
                    type="object"
                    name="apply_lot_ids_string"
                    context="{'recal_qty_done':True}"
                    attrs="{'invisible': [('template_tracking', '!=', 'virtual')]}"
                />
        </xpath>

    </field>
</record>

<record id="view_stock_move_lot_names" model="ir.ui.view">
            <field name="name">stock.move.lot_name.form</field>
            <field name="model">stock.move</field>
            <field name="priority">9999</field>
            <field name="arch" type="xml">
                <form string="Move Detail">
                    <field name="state" invisible="1" />
                    <field name="location_id" invisible="1" />
                    <field name="location_dest_id" invisible="1" />
                    <field name="picking_id" invisible="1" />
                    <field name="is_locked" invisible="1" />
                    <field name="picking_type_entire_packs" invisible="1" />
                    <group>
                        <group>
                            <field name="product_id" readonly="1" />
                            <label for="product_uom_qty" />
                            <div class="o_row">
                                <span><field
                                    name="product_uom_qty"
                                    readonly="1"
                                    nolabel="1"
                                /></span>
                                <span><field
                                    name="product_uom"
                                    readonly="1"
                                    nolabel="1"
                                /></span>
                            </div>
                            <label for="quantity_done" />
                            <div class="o_row">
                                <span><field
                                    name="quantity_done"
                                    readonly="1"
                                    nolabel="1"
                                /></span>
                                <span
                                attrs="{'invisible': [('state', '=', 'done')]}"
                            > / </span>
                                <span><field
                                    name="reserved_availability"
                                    nolabel="1"
                                    attrs="{'invisible': [('state', '=', 'done')]}"
                                /></span>
                                <span><field
                                    name="product_uom"
                                    readonly="1"
                                    nolabel="1"
                                /></span>
                            </div>


                        </group>
                    </group>
                    <!--field name="serial_name_ids"
                           attrs="{'readonly': ['|', ('state', '=', 'cancel'), '&amp;', ('state', '=', 'done'), ('is_locked', '=', True)]}"
                           context="{'default_move_id': id,
                                     'default_product_id': product_id,
                                     'default_usage': usage}">
                           <tree>
                                <field name="name"/>
                           </tree>
                    </field-->

                    <footer class="oe_edit_only">
                        <button
                        string="Apply"
                        name="apply_stock_lot_name"
                        class="oe_highlight"
                    />
                        <button string="Confirm" special="save" class="oe_highlight" />
                        <button string="Discard" special="cancel" />
                    </footer>
                </form>
            </field>
    </record>

    <record id="view_stock_move_partner" model="ir.ui.view">
        <field name="name">Stock Move Partner</field>
        <field name="model">stock.move</field>
        <field name="inherit_id" ref="stock.view_move_tree" />
        <field name="arch" type="xml">
            <field name="date" position="before">
                <field name="partner_id" />
            </field>
        </field>
    </record>
</odoo>
